/*!
* Dynamsoft JavaScript Library
* @product Dynamsoft Code Parser JS Edition
* @website http://www.dynamsoft.com
* @copyright Copyright 2024, Dynamsoft Corporation
* @author Dynamsoft
* @version 2.0.20
* @fileoverview Dynamsoft JavaScript Library for Code Parser
* More info on dcp JS: https://www.dynamsoft.com/code-parser/docs/web/programming/javascript/
*/
import{mapPackageRegister as e,loadWasm as t,getNextTaskID as s,mapTaskCallBack as i,worker as n,checkIsLink as r,requestResource as a,engineResourcePaths as c,workerAutoResources as o,compareVersion as d,innerVersions as l,CoreModule as u}from"dynamsoft-core";var p,f;function h(e){delete e.moduleId;const t=JSON.parse(e.jsonString).ResultInfo,s=e.fullCodeString;e.getFieldValue=e=>"fullcodestring"===e.toLowerCase()?s:g(t,e),e.getFieldMappingStatus=e=>y(t,e),e.getFieldValidationStatus=e=>_(t,e),delete e.fullCodeString}function g(e,t){for(let s of e){if(s.FieldName===t)return s.Value;if(s.ChildFields&&s.ChildFields.length>0){let e;for(let i of s.ChildFields)e=g(i,t);if(null!==e)return e}}return null}function y(e,t){for(let s of e){if(s.FieldName===t)return s.MappingStatus?Number(p[s.MappingStatus]):p.MS_NONE;if(s.ChildFields&&s.ChildFields.length>0){let e;for(let i of s.ChildFields)e=y(i,t);if(null!==e)return e}}return null}function _(e,t){for(let s of e){if(s.FieldName===t&&s.ValidationStatus)return s.ValidationStatus?Number(f[s.ValidationStatus]):f.VS_NONE;if(s.ChildFields&&s.ChildFields.length>0){let e;for(let i of s.ChildFields)e=_(i,t);if(null!==e)return e}}return null}!function(e){e[e.MS_NONE=0]="MS_NONE",e[e.MS_SUCCEEDED=1]="MS_SUCCEEDED",e[e.MS_FAILED=2]="MS_FAILED"}(p||(p={})),function(e){e[e.VS_NONE=0]="VS_NONE",e[e.VS_SUCCEEDED=1]="VS_SUCCEEDED",e[e.VS_FAILED=2]="VS_FAILED"}(f||(f={}));const S=e=>e&&"object"==typeof e&&"function"==typeof e.then;class m extends Promise{constructor(e){let t,s;super(((e,i)=>{t=e,s=i})),this._s="pending",this.resolve=e=>{this.isPending&&(S(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",s(e))},this.task=e}get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,S(e)?t=e:"function"==typeof e&&(t=new Promise(e)),t&&(async()=>{try{const s=await t;e===this._task&&this.resolve(s)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}}class k{constructor(){this._instanceID=void 0,this.bDestroyed=!1}_checkIsDisposed(){if(this.disposed)throw new Error('"CodeParser" instance has been disposed')}static async createInstance(){if(!e.license)throw Error("Module `license` is not existed.");await e.license.dynamsoft(),await t("dcp");const r=new k,a=new m;let c=s();return i[c]=async e=>{if(e.success)r._instanceID=e.instanceID,a.resolve(r);else{const t=Error(e.message);e.stack&&(t.stack=e.stack),a.reject(t)}},n.postMessage({type:"dcp_createInstance",id:c}),a}async dispose(){this._checkIsDisposed();let e=s();this.bDestroyed=!0,i[e]=e=>{if(!e.success){let t=new Error(e.message);throw t.stack=e.stack+"\n"+t.stack,t}},n.postMessage({type:"dcp_dispose",id:e,instanceID:this._instanceID})}get disposed(){return this.bDestroyed}async initSettings(e){return this._checkIsDisposed(),e&&["string","object"].includes(typeof e)?("string"==typeof e&&r(e)&&(e=await a(e,"text")),"object"==typeof e&&(e=JSON.stringify(e)),await new Promise(((t,r)=>{let a=s();i[a]=async e=>{if(e.success){const s=JSON.parse(e.response);if(0!==s.exception){let e=new Error(s.description?s.description:"Init Settings Failed.");return e.errorCode=s.exception,r(e)}return t(s)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},n.postMessage({type:"dcp_initSettings",id:a,instanceID:this._instanceID,body:{settings:e}})}))):console.error("Invalid settings.")}async resetSettings(){return this._checkIsDisposed(),await new Promise(((e,t)=>{let r=s();i[r]=async s=>{if(s.success)return e();{let e=new Error(s.message);return e.stack=s.stack+"\n"+e.stack,t(e)}},n.postMessage({type:"dcp_resetSettings",id:r,instanceID:this._instanceID})}))}async parse(e,t=""){if(this._checkIsDisposed(),!(e&&(e instanceof Array||e instanceof Uint8Array||"string"==typeof e)))throw new Error("`parseData` must pass in an Array or Uint8Array or string");return await new Promise(((r,a)=>{let c=s();e instanceof Array&&(e=Uint8Array.from(e)),"string"==typeof e&&(e=Uint8Array.from(this._stringToUint8Array(e))),i[c]=async e=>{if(e.success){let t=JSON.parse(e.parseResponse);return t.exception||h(t),r(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},n.postMessage({type:"dcp_parse",id:c,instanceID:this._instanceID,body:{source:e,taskSettingName:t}})}))}_stringToUint8Array(e){let t=[];for(let s=0;s<e.length;++s)t.push(e.charCodeAt(s));return t}}const E="undefined"==typeof self,w=(()=>{if(!E&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();null==c.dcp&&(c.dcp=w),o.dcp={js:!0,wasm:!0},e.dcp={handleParsedResultItem:h};const D="1.0.0";c.std.version&&d(c.std.version,D)<0&&(c.std.version=D,c.std.path=(e=>{if(null==e&&(e="./"),E);else{let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e})(w+`../../dynamsoft-capture-vision-std@${D}/dist/`));class I{static getVersion(){const e=l.dcp&&l.dcp.wasm,t=l.dcp&&l.dcp.worker;return`2.0.20(Worker: ${t||"Not Loaded"}, Wasm: ${e||"Not Loaded"})`}static async loadSpec(e,r){return await t("dcp"),await new Promise(((t,a)=>{let c=s();i[c]=async e=>{if(e.success)return t();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},r&&!r.endsWith("/")&&(r+="/"),n.postMessage({type:"dcp_appendResourceBuffer",id:c,body:{specificationPath:r||u.engineResourcePaths.dcp+"specification/",specificationName:e}})}))}}export{k as CodeParser,I as CodeParserModule,p as EnumMappingStatus,f as EnumValidationStatus};
